<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web File Share</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>File Share</h1>

        <div class="notice">
            ‚ö†Ô∏è T·∫•t c·∫£ c√°c file ƒë∆∞·ª£c t·∫£i l√™n s·∫Ω t·ª± ƒë·ªông b·ªã xo√° sau 2 gi·ªù.<br>
            üìÅ Gi·ªõi h·∫°n dung l∆∞·ª£ng file: <strong>500 MB</strong>
        </div>

        <div class="upload-section"></div>
            <h2>Upload a File</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" name="file" id="fileInput" required>
                <button type="submit">Upload</button>
            </form>

            <div class="progress-container">
                <progress id="progressBar" value="0" max="100"></progress>
                <span id="status">0%</span>
            </div>
        </div>

        <div class="download-section">
            <h2>Files Available for Download</h2>
            <table id="fileTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n file</th>
                        <th>Th·ªùi gian t·∫£i l√™n</th>
                        <th>H·∫øt h·∫°n l√∫c</th>
                    </tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Format timestamp to readable date
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('vi-VN');
        }

        // Function to refresh file list
        function refreshFileList() {
            fetch('/files')
                .then(response => response.json())
                .then(files => {
                    const fileList = document.getElementById("fileList");
                    fileList.innerHTML = '';
                    files.forEach((file, index) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td><a href="/download/${file.name}">${file.name}</a></td>
                            <td>${formatTime(file.uploadTime)}</td>
                            <td>${formatTime(file.expiryTime)}</td>
                        `;
                        fileList.appendChild(tr);
                    });
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Load file list on page load
            refreshFileList();

            // Handle file upload with progress bar
            const form = document.getElementById("uploadForm");
            const progressBar = document.getElementById("progressBar");
            const status = document.getElementById("status");

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const file = document.getElementById("fileInput").files[0];
                const maxSize = 500 * 1024 * 1024; // 500MB

                // Check file size before upload
                if (file.size > maxSize) {
                    status.textContent = "File qu√° l·ªõn! Gi·ªõi h·∫°n 500 MB";
                    status.style.color = "red";
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);

                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/upload", true);

                // Track upload progress
                xhr.upload.onprogress = function (event) {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        progressBar.value = percentComplete;
                        status.textContent = percentComplete + "%";
                    }
                };

                // Handle upload complete
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        progressBar.value = 0;
                        status.textContent = "Upload complete!";
                        status.style.color = "green";
                        document.getElementById("fileInput").value = "";
                        refreshFileList();
                    } else {
                        status.textContent = "Upload failed: " + xhr.responseText;
                        status.style.color = "red";
                    }
                };

                // Handle network errors
                xhr.onerror = function () {
                    status.textContent = "Network error - check connection";
                    status.style.color = "red";
                };

                // Handle timeout
                xhr.ontimeout = function () {
                    status.textContent = "Upload timeout - file too large?";
                    status.style.color = "red";
                };

                // Set timeout to 30 minutes
                xhr.timeout = 30 * 60 * 1000;

                xhr.send(formData);
            });
        });
    </script>
</body>
</html>
